import argparse
import pandas as pd
import random
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(description="Split dataset into train, val, and test.")
    parser.add_argument("--index-csv", required=True, help="Path to sequences.csv generated by prepare_mars.py")
    parser.add_argument("--output-csv", required=True, help="Path to save the new CSV with splits")
    parser.add_argument("--train-ratio", type=float, default=0.8, help="Ratio of IDs for training")
    parser.add_argument("--val-ratio", type=float, default=0.1, help="Ratio of IDs for validation")
    parser.add_argument("--test-ratio", type=float, default=0.1, help="Ratio of IDs for testing")
    parser.add_argument("--use-standard-split", action="store_true", help="Use standard MARS folders (train/test) and only split train into train/val")
    parser.add_argument("--seed", type=int, default=42, help="Random seed for reproducibility")
    
    args = parser.parse_args()
    
    # Normalize ratios if they don't sum to 1
    total = args.train_ratio + args.val_ratio + args.test_ratio
    train_r = args.train_ratio / total
    val_r = args.val_ratio / total
    
    random.seed(args.seed)
    
    df = pd.read_csv(args.index_csv)
    
    # Standardize column names
    rename_dict = {}
    if 'person_global_id' in df.columns:
        rename_dict['person_global_id'] = 'person_id'
    if 'rgb_dir' in df.columns:
        rename_dict['rgb_dir'] = 'frames_dir'
    if rename_dict:
        df = df.rename(columns=rename_dict)

    pids = sorted(df['person_id'].unique().tolist())
    random.shuffle(pids)
    num_total = len(pids)

    if args.use_standard_split and 'split' in df.columns:
        # Protocolo estándar: Respetar carpetas 'bbox_train' (train) y 'bbox_test' (test)
        # Solo dividimos el original 'train' para obtener 'val'
        orig_train_pids = sorted(df[df['split'] == 'train']['person_id'].unique().tolist())
        random.shuffle(orig_train_pids)
        num_val = int(len(orig_train_pids) * args.val_ratio / (args.train_ratio + args.val_ratio))
        
        val_pids = set(orig_train_pids[:num_val])
        train_pids = set(orig_train_pids[num_val:])
        
        df.loc[df['person_id'].isin(val_pids), 'split'] = 'val'
        df.loc[df['person_id'].isin(train_pids), 'split'] = 'train'
        print(f"Standard MARS Protocol: Split original train IDs into {len(train_pids)} train and {len(val_pids)} validation.")
    else:
        # Repartición personalizada (ej. 80/10/10) sobre TODO el dataset
        num_train = int(num_total * train_r)
        num_val = int(num_total * val_r)
        
        train_pids = set(pids[:num_train])
        val_pids = set(pids[num_train:num_train+num_val])
        test_pids = set(pids[num_train+num_val:])
        
        df.loc[df['person_id'].isin(train_pids), 'split'] = 'train'
        df.loc[df['person_id'].isin(val_pids), 'split'] = 'val'
        df.loc[df['person_id'].isin(test_pids), 'split'] = 'test'
        
        print(f"Custom Split (80/10/10 style): Train: {len(train_pids)}, Val: {len(val_pids)}, Test: {len(test_pids)} IDs.")

    df.to_csv(args.output_csv, index=False)
    print(f"Saved split metadata to {args.output_csv}")

if __name__ == "__main__":
    main()
